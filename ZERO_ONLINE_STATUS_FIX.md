# ğŸ”¥ "0/Måœ¨çº¿"çŠ¶æ€é—®é¢˜ä¿®å¤

## é—®é¢˜ç—‡çŠ¶
å°½ç®¡å·²ç»ä¼˜åŒ–äº†çŠ¶æ€åˆ·æ–°é¢‘ç‡ï¼Œç”¨æˆ·ä»ç„¶ç»å¸¸çœ‹åˆ°"0/6åœ¨çº¿"çš„çŠ¶æ€æ˜¾ç¤ºï¼Œå³ä½¿å½“å‰è®¾å¤‡æ˜æ˜¾æ˜¯åœ¨çº¿çš„ã€‚

## æ ¹æœ¬åŸå› åˆ†æ

### 1. å½“å‰è®¾å¤‡çŠ¶æ€æ ‡è®°ä¸ä¸€è‡´
- **é—®é¢˜**ï¼šå½“å‰è®¾å¤‡æ²¡æœ‰è¢«æ­£ç¡®æ ‡è®°ä¸º `isCurrentDevice = true`
- **å½±å“**ï¼šå¯¼è‡´å½“å‰è®¾å¤‡ä¹Ÿè¢«æŒ‰ç…§æœåŠ¡å™¨çŠ¶æ€åˆ¤æ–­ï¼Œå¯èƒ½è¢«è¯¯åˆ¤ä¸ºç¦»çº¿

### 2. åœ¨çº¿çŠ¶æ€å­—æ®µä¸ç»Ÿä¸€
- **é—®é¢˜**ï¼šå­˜åœ¨ `isOnline` å’Œ `is_online` ä¸¤ä¸ªå­—æ®µï¼Œå¯èƒ½å‡ºç°ä¸ä¸€è‡´
- **å½±å“**ï¼šä¸åŒåœ°æ–¹ä½¿ç”¨ä¸åŒå­—æ®µï¼Œå¯¼è‡´çŠ¶æ€åˆ¤æ–­ç»“æœä¸ä¸€è‡´

### 3. æœåŠ¡å™¨çŠ¶æ€åŒæ­¥å»¶è¿Ÿ
- **é—®é¢˜**ï¼šæœåŠ¡å™¨ç«¯çš„è®¾å¤‡çŠ¶æ€æ›´æ–°å¯èƒ½æœ‰å»¶è¿Ÿ
- **å½±å“**ï¼šå³ä½¿è®¾å¤‡å®é™…åœ¨çº¿ï¼ŒæœåŠ¡å™¨å¯èƒ½ä»ç„¶è®¤ä¸ºç¦»çº¿

## ä¿®å¤æ–¹æ¡ˆ

### 1. å¼ºåŒ–å½“å‰è®¾å¤‡æ ‡è®°æœºåˆ¶
**æ–‡ä»¶ï¼š** `lib/providers/auth_provider.dart`

```dart
// åœ¨ refreshProfile æ–¹æ³•ä¸­ç¡®ä¿å½“å‰è®¾å¤‡è¢«æ­£ç¡®æ ‡è®°
if (isCurrentDevice) {
  // ğŸ”¥ å…³é”®ä¿®å¤ï¼šå½“å‰è®¾å¤‡å§‹ç»ˆåœ¨çº¿
  isOnline = true;
  device['isOnline'] = true;
  device['is_online'] = true; // åŒæ—¶è®¾ç½®ä¸¤ä¸ªå­—æ®µç¡®ä¿å…¼å®¹
  device['isCurrentDevice'] = true; // æ˜ç¡®æ ‡è®°ä¸ºå½“å‰è®¾å¤‡
  print('  - å½“å‰è®¾å¤‡è®¾ç½®ä¸ºåœ¨çº¿');
}
```

**æ•ˆæœï¼š** ç¡®ä¿å½“å‰è®¾å¤‡åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½è¢«æ­£ç¡®æ ‡è®°å’Œè®¾ç½®ä¸ºåœ¨çº¿çŠ¶æ€

### 2. ç»Ÿä¸€åœ¨çº¿çŠ¶æ€åˆ¤æ–­é€»è¾‘
**æ–‡ä»¶ï¼š** `lib/providers/group_provider.dart`

```dart
// åœ¨ onlineDevicesCount getter ä¸­
// ğŸ”¥ æ–°å¢ï¼šç‰¹æ®Šå¤„ç†å½“å‰è®¾å¤‡ï¼Œå½“å‰è®¾å¤‡å§‹ç»ˆåœ¨çº¿
if (device['isCurrentDevice'] == true) {
  isOnline = true;
  print('  - åˆ¤å®šç»“æœ: åœ¨çº¿ (å½“å‰è®¾å¤‡)');
} else if (device['is_logged_out'] == true || device['isLoggedOut'] == true) {
  isOnline = false;
  print('  - åˆ¤å®šç»“æœ: ç¦»çº¿ (å·²ç™»å‡º)');
} else if (device['isOnline'] == true || device['is_online'] == true) {
  isOnline = true;
  print('  - åˆ¤å®šç»“æœ: åœ¨çº¿');
} else {
  isOnline = false;
  print('  - åˆ¤å®šç»“æœ: ç¦»çº¿ (é»˜è®¤)');
}
```

**æ•ˆæœï¼š** å½“å‰è®¾å¤‡ä¼˜å…ˆçº§æœ€é«˜ï¼Œç¡®ä¿ä¸ä¼šè¢«è¯¯åˆ¤ä¸ºç¦»çº¿

### 3. å¢å¼ºçŠ¶æ€åˆ·æ–°æœºåˆ¶
**æ–‡ä»¶ï¼š** `lib/widgets/connection_status_widget.dart`

```dart
// å¼ºåˆ¶åˆ·æ–°è®¾å¤‡çŠ¶æ€æ—¶å‘é€å¤šä¸ªè¯·æ±‚
_wsManager.emit('request_group_devices_status', {...});
_wsManager.emit('get_online_devices', {...});
_wsManager.emit('request_device_status', {...});
_wsManager.emit('device_activity_update', {
  'status': 'active',
  'timestamp': DateTime.now().toIso8601String(),
  'last_active': DateTime.now().toIso8601String(),
});
```

**æ•ˆæœï¼š** é€šè¿‡å¤šç§æ–¹å¼ç¡®ä¿æœåŠ¡å™¨äº†è§£å½“å‰è®¾å¤‡çš„æ´»è·ƒçŠ¶æ€

### 4. æ·»åŠ è¯Šæ–­å·¥å…·
**æ–‡ä»¶ï¼š** `lib/providers/group_provider.dart`

```dart
// æ–°å¢è¯Šæ–­æ–¹æ³•
void diagnosisDeviceStatus() {
  print('\n========== ğŸ” è®¾å¤‡çŠ¶æ€è¯Šæ–­å¼€å§‹ ==========');
  
  // è¯¦ç»†è¾“å‡ºæ¯ä¸ªè®¾å¤‡çš„çŠ¶æ€ä¿¡æ¯
  for (var device in devices) {
    print('è®¾å¤‡: ${device['name']}');
    print('  - isCurrentDevice: ${device['isCurrentDevice']}');
    print('  - isOnline: ${device['isOnline']}');
    print('  - is_online: ${device['is_online']}');
    print('  - åŸå§‹æ•°æ®: $device');
  }
  
  print('========== ğŸ” è®¾å¤‡çŠ¶æ€è¯Šæ–­ç»“æŸ ==========\n');
}
```

**æ•ˆæœï¼š** æä¾›è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼Œå¸®åŠ©å¿«é€Ÿå®šä½é—®é¢˜

### 5. è¯¦ç»†è°ƒè¯•è¾“å‡º
åœ¨å…³é”®ä½ç½®æ·»åŠ è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼š

```dart
// åœ¨ onlineDevicesCount getter ä¸­
print('ğŸ” è°ƒè¯•è®¾å¤‡çŠ¶æ€ï¼š');
print('  - è®¾å¤‡åç§°: ${device['name']}');
print('  - è®¾å¤‡ID: ${device['id']}');
print('  - isCurrentDevice: ${device['isCurrentDevice']}');
print('  - isOnline: ${device['isOnline']}');
print('  - is_online: ${device['is_online']}');
print('  - åˆ¤å®šç»“æœ: ${isOnline ? "åœ¨çº¿" : "ç¦»çº¿"}');
```

## ä½¿ç”¨è¯´æ˜

### 1. è§¦å‘è¯Šæ–­
- ç‚¹å‡»"N/Måœ¨çº¿"çš„è®¾å¤‡æ•°é‡éƒ¨åˆ†
- ç³»ç»Ÿä¼šè‡ªåŠ¨è¾“å‡ºè¯¦ç»†çš„è®¾å¤‡çŠ¶æ€è¯Šæ–­ä¿¡æ¯
- åŒæ—¶è§¦å‘å¼ºåˆ¶çŠ¶æ€åˆ·æ–°

### 2. æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯
åœ¨åº”ç”¨è¿è¡Œæ—¶ï¼Œæ§åˆ¶å°ä¼šè¾“å‡ºè¯¦ç»†çš„è®¾å¤‡çŠ¶æ€ä¿¡æ¯ï¼š
```
ğŸ” è°ƒè¯•ï¼šå½“å‰ç¾¤ç»„æœ‰ 6 å°è®¾å¤‡
ğŸ” è°ƒè¯•è®¾å¤‡çŠ¶æ€ï¼š
  - è®¾å¤‡åç§°: MacBook Pro
  - è®¾å¤‡ID: xxx
  - isCurrentDevice: true
  - isOnline: true
  - is_online: true
  - åˆ¤å®šç»“æœ: åœ¨çº¿ (å½“å‰è®¾å¤‡)
```

### 3. éªŒè¯ä¿®å¤æ•ˆæœ
- å½“å‰è®¾å¤‡åº”è¯¥å§‹ç»ˆæ˜¾ç¤ºä¸ºåœ¨çº¿
- åœ¨çº¿è®¡æ•°è‡³å°‘åº”è¯¥æ˜¯ 1ï¼ˆåŒ…å«å½“å‰è®¾å¤‡ï¼‰
- çŠ¶æ€åº”è¯¥åœ¨2-3ç§’å†…æ›´æ–°

## æŠ€æœ¯è¦ç‚¹

### 1. ä¼˜å…ˆçº§è®¾è®¡
```
çŠ¶æ€åˆ¤æ–­ä¼˜å…ˆçº§ï¼š
1. isCurrentDevice = true â†’ å¼ºåˆ¶åœ¨çº¿
2. is_logged_out = true â†’ å¼ºåˆ¶ç¦»çº¿  
3. isOnline/is_online = true â†’ åœ¨çº¿
4. é»˜è®¤ â†’ ç¦»çº¿
```

### 2. å­—æ®µå…¼å®¹æ€§
```
çŠ¶æ€å­—æ®µæ˜ å°„ï¼š
- isOnline: å®¢æˆ·ç«¯æ ‡å‡†å­—æ®µ
- is_online: æœåŠ¡å™¨å­—æ®µ
- isCurrentDevice: å®¢æˆ·ç«¯æ ‡è¯†å­—æ®µ
- is_logged_out: æœåŠ¡å™¨ç™»å‡ºçŠ¶æ€å­—æ®µ
```

### 3. å®æ—¶åˆ·æ–°ç­–ç•¥
```
å¤šå±‚çº§çŠ¶æ€åˆ·æ–°ï¼š
- WebSocketManager: æ¯2ç§’ä¸»åŠ¨è¯·æ±‚
- Homeé¡µé¢: æ¯5ç§’å®šæœŸåŒæ­¥
- UIç»„ä»¶: æ¯3ç§’è‡ªåŠ¨åˆ·æ–°
- ç”¨æˆ·äº¤äº’: ç«‹å³è§¦å‘åˆ·æ–°
```

## é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰é—®é¢˜
- âŒ ç»å¸¸æ˜¾ç¤º"0/6åœ¨çº¿"
- âŒ å½“å‰è®¾å¤‡ä¹Ÿè¢«è¯¯åˆ¤ä¸ºç¦»çº¿
- âŒ çŠ¶æ€æ›´æ–°å»¶è¿Ÿä¸¥é‡

### ä¿®å¤åæ•ˆæœ
- âœ… å½“å‰è®¾å¤‡å§‹ç»ˆæ˜¾ç¤ºä¸ºåœ¨çº¿
- âœ… åœ¨çº¿è®¡æ•°è‡³å°‘ä¸º1
- âœ… çŠ¶æ€æ›´æ–°å®æ—¶å“åº”
- âœ… è¯¦ç»†è°ƒè¯•ä¿¡æ¯ä¾¿äºé—®é¢˜å®šä½

## éªŒè¯æ­¥éª¤

1. **å¯åŠ¨åº”ç”¨**ï¼šæ£€æŸ¥å½“å‰è®¾å¤‡æ˜¯å¦è¢«æ­£ç¡®æ ‡è®°ä¸ºåœ¨çº¿
2. **ç‚¹å‡»è®¾å¤‡æ•°é‡**ï¼šè§¦å‘è¯Šæ–­ï¼ŒæŸ¥çœ‹è¯¦ç»†çŠ¶æ€ä¿¡æ¯
3. **è§‚å¯Ÿå®æ—¶æ›´æ–°**ï¼šçŠ¶æ€åº”è¯¥åœ¨2-3ç§’å†…åˆ·æ–°
4. **æ£€æŸ¥æ§åˆ¶å°è¾“å‡º**ï¼šç¡®è®¤è°ƒè¯•ä¿¡æ¯æ­£ç¡®è¾“å‡º
5. **å¤šè®¾å¤‡æµ‹è¯•**ï¼šåœ¨å¤šå°è®¾å¤‡é—´éªŒè¯çŠ¶æ€åŒæ­¥

## æ•…éšœæ’é™¤

### å¦‚æœä»ç„¶æ˜¾ç¤º0åœ¨çº¿
1. ç‚¹å‡»è®¾å¤‡æ•°é‡è§¦å‘è¯Šæ–­
2. æ£€æŸ¥æ§åˆ¶å°è¾“å‡ºçš„è®¾å¤‡çŠ¶æ€ä¿¡æ¯
3. ç¡®è®¤å½“å‰è®¾å¤‡çš„ `isCurrentDevice` å­—æ®µæ˜¯å¦ä¸º `true`
4. æ£€æŸ¥WebSocketè¿æ¥çŠ¶æ€
5. æ‰‹åŠ¨è§¦å‘çŠ¶æ€åˆ·æ–°

### è°ƒè¯•å‘½ä»¤
```dart
// åœ¨ä»£ç ä¸­æ·»åŠ ä¸´æ—¶è°ƒè¯•
final groupProvider = Provider.of<GroupProvider>(context, listen: false);
groupProvider.diagnosisDeviceStatus();
```

é€šè¿‡è¿™äº›ä¿®å¤æªæ–½ï¼Œ"0/Måœ¨çº¿"çš„é—®é¢˜åº”è¯¥å¾—åˆ°æ ¹æœ¬æ€§è§£å†³ã€‚ 